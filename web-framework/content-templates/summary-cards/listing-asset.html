<script runat="server">
  // %asset_assetid%

  // get the summary card list settings
  var layout = {
  	 imageShape : "%nested_get_content_container^as_asset:asset_metadata_template.card.image.shape^replace:circle:img-circle^replace:natural: %",
  	 imageShapeClass : "image-shape-%nested_get_content_container^as_asset:asset_metadata_template.card.image.shape%",
  	 flairText : "%nested_get_content_container^as_asset:asset_metadata_template.card.initial.flair%",
  	 cardLayout : "%nested_get_content_container^as_asset:asset_metadata_template.card.layout%",
  	 buttonText : "More Details"
  }

  //  get details about the current card / asset
  var card = {
    name : '%asset_name%',
    position : '%asset_position%',
    imageTitle : '%asset_thumbnail_title%',
    imageAlt : '%asset_thumbnail_alt%',
    imageUrl : '%asset_thumbnail_v_newsdetails_url^empty:{asset_thumbnail_url}%',
    overrideUrl : '%asset_metadata_jcu.summarycard.override.url%',
    url : '%asset_metadata_jcu.summarycard.override.url^empty:{asset_url}%'
  }
  
  function linkedImageHtml(linkWrapper) {
    linkWrapper = linkWrapper || { prepend : '', append : '' }

    var imageHtml = ''

    print('<!-- linkWrapper.prepend(' + linkWrapper.prepend + ') linkWrapper.append (' + linkWrapper.append + ')  -->')
    
    if (card.imageUrl) {
      imageHtml = linkWrapper.prepend + linkTagOpen() +
        '<img class="img-fluid ' + layout.imageShape + '" src="' + card.imageUrl + '" alt="' + card.imageAlt + '" title="' + card.imageTitle + '"/>' +
        linkTagClose() + linkWrapper.append
    }

    return imageHtml
  }   // linkedImageHtml

  function linkTagOpen(linkClasses) {
    // if there is an override.url set then use that, otherwise get the url for the original asset
    // override.urls should open in a separate window
    linkClasses = linkClasses || ''

    const targetAttribute = ( card.overrideUrl ? 'target:"_blank" rel:"external noopener" ' : 'target:"_self"' )
    return '<a class="' + linkClasses + '" ' + targetAttribute + ' href="' + card.url + '">'
  }   // linkTagOpen
  
  function linkTagClose() {
    return '</a>'
  }
 
  function drawThumbnailGridCard() {
    //  The thumbnail grid will responsively show 3 columns for xs screens,
    //  4 columns for small and medium screens and 6 columns for large and xlarge screens.
    //  Since the cells may not be exactly the same height we need to add an invisible
    //  full width row at each break point to make sure the layout looks good.

    //  The thumbnail grid assumes that there should always be an image.

    const imageWrapper = { prepend : '<div class="thumbnail-wrapper">', append : '</div>'}
    const addFlair = card.position == 1 && layout.flairText
    
    print('<div class="col-xs-4 col-sm-3 col-lg-2 ' + (addFlair ? ' thumbnail-flair ' : '') + '">')
    print(linkedImageHtml(imageWrapper))
    print('<div class="small thumbnail-text"><p>' + (addFlair ? '<strong>' + layout.flairText + '</strong>' : '') + '<br/>' + card.name + '</p></div>')
    print('</div>')

    if (card.position % 3 == 0) {
      print('<div class="hidden-sm-up col-xs-12"></div>');    // show 3 columns for xs screens
    }

    if (card.position % 4 == 0) {
      print('<div class="hidden-xs-down hidden-lg-up col-xs-12"></div>');    // show 4 columns for small and medium screens
    }

    if (card.position % 6 == 0) {
      print('<div class="hidden-md-down col-xs-12"></div>');    // show 6 columns for large screens
    }
  }   // drawThumbnailGridCard

  function drawGridCard() {
    //  Uses the bootstrap Card tags to layout the assets summary cards
    //  These cards look good with or without an image

    print('<div class="card card-outline-secondary">')
    print(linkedImageHtml())
    print('<div class="card-block">')
    print('<h4 class="card-title">%asset_attribute_name%</h4>')
    print('<p class="card-text">' + JCU.phrasingHtmlFromKeyword('asset_metadata_jcu.summarycard.description') + '</p>')

    print(linkTagOpen("btn btn-secondary") + layout.buttonText + linkTagClose())
    print('</div></div>')
  }   // drawGridCard

  function drawColumnCard() {
    //  Summary cards are displayed as a single column. Images are optional.
    print('<div class="row m-b-3">');

    // image section
    var imageOptions = { prepend : '<div class="col-sm-3 ">', append : '</div>'}
    print(linkedImageHtml(imageOptions))

    // text section
    var columnWidth = '%asset_thumbnail_assetid^notempty:9^empty:12%'

    print('<div class="col-sm-' + columnWidth + '">')

    print('<h5>' + card.name + '%nbsp;&nbsp;<small>' + JCU.phrasingHtmlFromKeyword('asset_metadata_jcu.features.byline') + '</small></h5>')
    JCU.printPhrasingHtmlFromKeyword('asset_metadata_jcu.summarycard.description', { prepend : "<p>", append : "</p>"})

    print(linkTagOpen("btn-link") + layout.buttonText + linkTagClose())
    print('</div></div>');  // close text column, close row
  }   // drawColumnCard
  
  if (layout.cardLayout == "mosaicGrid") {
    drawGridCard()
  } else if (layout.cardLayout == "column") {
    drawColumnCard()
  } else if (layout.cardLayout == "thumbnails") {
    drawThumbnailGridCard()
  } 
</script>
