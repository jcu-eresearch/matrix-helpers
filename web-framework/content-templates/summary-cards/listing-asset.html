<script runat="server">
  // %asset_assetid%

  // get the summary card list settings
  var layout = {
  	 imageShape : "%nested_get_content_container^as_asset:asset_metadata_template.card.image.shape^replace:circle:img-circle^replace:natural: %",
  	 imageShapeClass : "image-shape-%nested_get_content_container^as_asset:asset_metadata_template.card.image.shape%",
  	 flairText : "%nested_get_content_container^as_asset:asset_metadata_template.card.initial.flair%",
  	 cardLayout : "%nested_get_content_container^as_asset:asset_metadata_template.card.layout%",
  	 buttonText : "%nested_get_content_container^as_asset:asset_metadata_template.card.button.text%",
     gridCardsPerRow : 3
  }
  
  var columnLayout = {
     picturePosition : "%nested_get_content_container^as_asset:asset_metadata_template.picture.position%",
     pictureColumns : "%nested_get_content_container^as_asset:asset_metadata_template.picture.size^json_decode^index:piccols%",
     textColumns : "%nested_get_content_container^as_asset:asset_metadata_template.picture.size^json_decode^index:textcols%"
  }

  print('<!-- picturePosition(' + columnLayout.picturePosition + ')  pictureColumns(' + columnLayout.pictureColumns + ') textColumns(' + columnLayout.textColumns + ') -->')
  print('<!-- nested... (%nested_get_content_container^as_asset:asset_metadata_template.picture.position%) -->')
  print('<!-- nested... ( %nested_get_content_container^as_asset:asset_metadata_template.picture.size%) -->')
  
  //  get details about the current card / asset
  var card = {
    id : "%asset_assetid%",
    name : "%asset_name^escapequotes%",
    position : "%asset_position%",
    imageTitle : "%asset_thumbnail_title^escapequotes%",
    imageAlt : "%asset_thumbnail_alt^escapequotes%",
    imageUrl : "%asset_thumbnail_v_newsdetails_url^empty:{asset_thumbnail_url}^escapequotes%",
    overrideUrl : "%asset_metadata_jcu.summarycard.override.url^escapequotes%",
    url : "%asset_metadata_jcu.summarycard.override.url^empty:{asset_url}^escapequotes%"
  }
  
  function linkedImageHtml(linkWrapper) {
    linkWrapper = linkWrapper || { prepend : '', append : '' }

    var imageHtml = ''

    if (card.imageUrl) {
      imageHtml = linkWrapper.prepend + linkTagOpen() +
        '<img class="img-fluid ' + layout.imageShape + '" src="' + card.imageUrl + '" alt="' + card.imageAlt + '" title="' + card.imageTitle + '"/>' +
        linkTagClose() + linkWrapper.append
    }

    return imageHtml
  }   // linkedImageHtml

  function linkTagOpen(linkClasses) {
    // if there is an override.url set then use that, otherwise get the url for the original asset
    // override.urls should open in a separate window
    linkClasses = linkClasses || ''

    const targetAttribute = ( card.overrideUrl ? 'target="_blank" rel="external noopener" ' : 'target="_self"' )
    return '<a class="' + linkClasses + '" ' + targetAttribute + ' href="' + card.url + '">'
  }   // linkTagOpen
  
  function linkTagClose() {
    return '</a>'
  }
 
  function drawThumbnailGridCard() {
    //  The thumbnail grid will responsively show 3 columns for xs screens,
    //  4 columns for small and medium screens and 6 columns for large and xlarge screens.
    //  Since the cells may not be exactly the same height we need to add an invisible
    //  full width row at each break point to make sure the layout looks good.

    //  The thumbnail grid assumes that there should always be an image.

    const imageWrapper = { prepend : '<div class="thumbnail-wrapper">', append : '</div>'}
    const addFlair = card.position == 1 && layout.flairText
    
    print('<div class="col-xs-4 col-sm-3 col-lg-2 ' + (addFlair ? ' thumbnail-flair ' : '') + '">')
    print(linkedImageHtml(imageWrapper))
    print('<div class="small thumbnail-text"><p>' + (addFlair ? '<strong>' + layout.flairText + '</strong>' : '') + '<br/>' + card.name + '</p></div>')
    print('</div>')

    if (card.position % 3 == 0) {
      print('<div class="hidden-sm-up col-xs-12"></div>');    // show 3 columns for xs screens
    }

    if (card.position % 4 == 0) {
      print('<div class="hidden-xs-down hidden-lg-up col-xs-12"></div>');    // show 4 columns for small and medium screens
    }

    if (card.position % 6 == 0) {
      print('<div class="hidden-md-down col-xs-12"></div>');    // show 6 columns for large screens
    }
  }   // drawThumbnailGridCard

  function drawGridCard(isFixedGrid) {
    //  Uses the bootstrap Card tags to layout the assets summary cards
    //  These cards look good with or without an image

    print('<div class="card card-outline-secondary">')
    print(linkedImageHtml())
    print('<div class="card-block">')
    print('<h4 class="card-title">' + card.name + '</h4>')
    print('<h5 class="card-title text-muted"><small>' + JCU.phrasingHtmlFromKeyword('globals_asset_metadata_jcu.features.byline:' + card.id) + '</small></h5>')
    print('<p class="card-text">' + JCU.phrasingHtmlFromKeyword('globals_asset_metadata_jcu.summarycard.description:' + card.id) + '</p>')

    print(linkTagOpen("btn btn-secondary") + layout.buttonText + linkTagClose())
    print('</div></div>')
    
    if (isFixedGrid && (card.position % layout.gridCardsPerRow == 0))
      print('</div><div class="card-deck m-t-2">')
  }   // drawGridCard

  function drawColumnCard() {
    //  Summary cards are displayed as a single column. Images are optional.
    print('<div class="row m-b-3">');

    // image section
    var imagePosition = (columnLayout.picturePosition == 'left' ? '' : ' col-sm-push-' + columnLayout.textColumns)
    var imageOptions = { prepend : '<div class="col-sm-' + columnLayout.pictureColumns + imagePosition + '">', append : '</div>'}
    print(linkedImageHtml(imageOptions))

    // text section
    var columnWidth = (card.imageUrl ? columnLayout.textColumns : '12')
    var textPosition = (card.imageUrl && columnLayout.picturePosition == 'right' ? ' col-sm-pull-' + columnLayout.pictureColumns : '')

    print('<div class="col-sm-' + columnWidth + textPosition + '">')

    // if the text column width is smaller then drop the byline to the line below the name
    var spacer = '&nbsp;&nbsp;'
    if (columnLayout.textColumns < 9)
      spacer = '</h4><h4>'

    print('<h4>' + card.name + '</h4><h5>' + '<small>' + JCU.phrasingHtmlFromKeyword('globals_asset_metadata_jcu.features.byline:' + card.id) + '</small></h5>')
    JCU.printPhrasingHtmlFromKeyword('globals_asset_metadata_jcu.summarycard.description:' + card.id, { prepend : "<p>", append : "</p>"})

    print(linkTagOpen("btn-link") + layout.buttonText + linkTagClose())
    print('</div></div>');  // close text column, close row
  }   // drawColumnCard
  
  if (JCU.debug) {
	print('<!-- About to render ' + layout.cardLayout + ' for Summary Cards -->')
	print('<!-- card.id(' + card.id + ') card.name(' + card.name + ') card.position(' + card.position + ') -->')
  }
	
  if (layout.cardLayout == "mosaicGrid") {
    drawGridCard(false)
  } else if (layout.cardLayout == "column") {
    drawColumnCard()
  } else if (layout.cardLayout == "thumbnails") {
    drawThumbnailGridCard()
  } else if (layout.cardLayout == "grid") {
    drawGridCard(true)
  }
</script>
