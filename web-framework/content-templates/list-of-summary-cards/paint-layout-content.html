<script runat="server">var parts = JCU.extractContentContainerParts("%asset_contents^json_encode%")</script>
<script runat="server">print(parts.opening)</script>
    class="container content-block %globals_asset_metadata_jcu.features.theme^eq:content:jcu-content%" aria-label="%asset_metadata_template.title.title^striphtml% %asset_metadata_template.title.subtitle^striphtml%">
    <div class="row">
        <div class="col-xs-12 col-md-10 col-md-offset-1 container">

            %begin_asset_metadata_template.title.display^eq:show%
            <h3 class="%asset_metadata_template.title.alignment%">
              <script runat="server">JCU.printPhrasingHtmlFromKeyword('globals_asset_metadata_template.title.title:%asset_assetid%')</script>
              <script runat="server">JCU.printPhrasingHtmlFromKeyword('globals_asset_metadata_template.title.subtitle:%asset_assetid%', {prepend: '<br><span class="lead">', append: '</span>'})</script>
            </h3>
            %end_asset%

            <div class="row m-b-2">

        <style>
            .thumbnail-text { 
              padding : 0 4px;
              margin-bottom: 1em;
              line-height: 5em;
              min-height: 5em;
              background-image : linear-gradient(to top, rgba(200,200,200, 0.2), rgba(200,200,200, 0) 2em);
              border-top : 1px solid rgb(200,200,200);
              border-bottom : 1px solid rgb(200,200,200);
            }

            .thumbnail-text p {
              line-height: 1.3;
              display: inline-block;
              margin: 0;
              vertical-align: middle;
            }

            .thumbnail-wrapper {
              height : 0;
              padding-bottom: 100%;
              background-image : linear-gradient(to top, rgba(200,200,200, 0.2), rgba(200,200,200, 0) 2em);
            }
        </style>

        <script runat="server">
          var assetList="%asset_metadata_template.list.items%"
          var cardLayout = "%asset_metadata_template.card.layout%"

          assetList = assetList.slice(1,-1)
          var assets = assetList.split(",")
          var imageShape = '%asset_metadata_template.card.image.shape^replace:circle:img-circle^replace:natural: %'

          print('<pre>imageShape is ' + imageShape + '</pre>')  // debugging


          // only used for thumbnail grid
          var columnCount = 0

          if (cardLayout == "mosaicGrid") {
            print('<div class="card-columns">')
            _.each(assets, drawGridCard)
            print('</div>')
          } else if (cardLayout == "column") {
            print('<div class="container-fluid">')
            _.each(assets, drawColumnCard)
            print('</div>')
          } else if (cardLayout == "thumbnails") {
              print('<div class="container-fluid"><div class="row">')
              _.each(assets, drawThumbnailGridCard)
              print('</div></div>')
          } else
            print('<div class="alert alert-info">Card layout ' + cardLayout + ' not supported yet </div>')


          function buildCardHref(assetId) {
            const externalUrlTarget = ' target="_blank" rel="external noopener" '

            return('%globals_asset_metadata_jcu.summarycard.override.url:' + assetId + '^prepend_if:' + externalUrlTarget + 'href="^empty:href="./?a=' + assetId +'^append_if:"%')
          }   // buildCardHref
 
          function buildCardLinkedImage(assetId, imageContainer) {
            imageContainer = imageContainer || { prepend : '', append : ''}
/*
// there is still a problem here - it is ignoring the begin_globals conditionals and always outputting the content they wrap

print('<pre>buildCardLinkedImage jcu.summarycard.image - ' + '%globals_asset_metadata_jcu.summarycard.image:' + assetId + '^empty:image is empty%</pre>')

print('%begin_globals_asset_metadata_jcu.summarycard.image:' + assetId + '%')
print('<pre>we have an image</pre>')
print('%end_globals' + '%')
print('%begin_globals_asset_metadata_jcu.summarycard.image:' + assetId + '^empty:0%')
print('<pre>returning 0 if image is empty</pre>')
print('%end_globals' + '%')
print('%begin_globals_asset_metadata_jcu.summarycard.image:' + assetId + '^empty:false%')
print('<pre>returning false if image is empty</pre>')
print('%end_globals' + '%')
*/
            // if an image exists then wrap it with the image container and link
            var linkTagOpen = 'begin_globals_asset_metadata_jcu.summarycard.image:' + assetId + '%\n' +
              imageContainer.prepend + '<a ' + buildCardHref(assetId) + '>' + '\n%end_globals'
//            print('<!--\n' + linkTagOpen + '\n-->')

            // build the image tag
            var imageWrapper = { prepend: '<img class="img-fluid ' + imageShape + '" src="./?a=', append: '\\:v3"/>' }
            var imageTag = 'globals_asset_metadata_jcu.summarycard.image:' + assetId +
             '^prepend_if:' + imageWrapper.prepend +
             '^append_if:' + imageWrapper.append + ''
//             print('<!-- buildCardLinkedImage - imageTag \n' + imageTag + '\n-->')

            var linkTagClose = 'begin_globals_asset_metadata_jcu.summarycard.image:' + assetId + '%\n' + 
              '</a>' + imageContainer.append + '\n%end_globals'
//          print('<!--\n' + linkTagClose + '\n-->')

            return('\n%' + linkTagOpen + '%\n%' + imageTag + '%\n%' + linkTagClose + '%')
          }   // buildCardLinkedImage

          function buildCardImage(assetId, options) {
            options = options || { prepend : '', append : ''}

            var imageWrapper = { prepend: '<img class="img-fluid ' + imageShape + '" src="./?a=', append: '\\:v3"/>' }

            return('%globals_asset_metadata_jcu.summarycard.image:' + assetId +
             '^prepend_if:' + options.prepend + imageWrapper.prepend +
             '^append_if:' + imageWrapper.append + options.append +
             '%'
            )
          }

          function drawThumbnailGridCard(assetId, index, list) {
            ++columnCount;
            print('<div class="col-sm-2 col-xs-4">')
            print('<div class="thumbnail-wrapper"><a ' + buildCardHref(assetId) + '>' + buildCardImage(assetId) + '</a></div>')
            print('<div class="small thumbnail-text"><p>%globals_asset_attribute_name:' + assetId + '%</p></div>')
            print('</div>')

            if (columnCount % 3 == 0) {
              print('<div class="hidden-sm-up col-xs-12"></div>')    // close the row and start a new one
            }

            if (columnCount % 6 == 0) {
              print('<div class="hidden-xs-down col-xs-12"></div>')    // close the row and start a new one
            }

          }   // drawThumbnailGridCard


          function drawGridCard(assetId) {
            print('<div class="card card-outline-secondary">')

            print('<a ' + buildCardHref(assetId) + '>' + buildCardImage(assetId) + '</a>')

            print('<div class="card-block">')
            print('<h4 class="card-title">%globals_asset_attribute_name:' + assetId + '%</h4>')
            print('<p class="card-text">' + JCU.phrasingHtmlFromKeyword('globals_asset_metadata_jcu.summarycard.description:' + assetId) + '</p>')

            var buttonText = "More Details"
            print('<a class="btn btn-secondary" ' + buildCardHref(assetId) + '>' + buttonText + '</a>')
            print('</div></div>')
          }   // drawGridCard

          function drawColumnCard(assetId) {
            print('<div class="row m-b-3">')

            // image section
            var imageOptions = { prepend : '<div class="col-sm-3 ">', append : '</div>'}
            print(buildCardLinkedImage(assetId, imageOptions))

            // text section
            var columnWidth = '%globals_asset_metadata_jcu.summarycard.image:' + assetId + '^notempty:9^empty:12%'

            print('<div class="col-sm-' + columnWidth + '">')

            var byline = 'globals_asset_metadata_jcu.features.byline:' + assetId

            print('<h5>%globals_asset_attribute_name:' + assetId + '%    <small>' + JCU.phrasingHtmlFromKeyword(byline) + '</small></h5>')
            JCU.printPhrasingHtmlFromKeyword('globals_asset_metadata_jcu.summarycard.description:' + assetId, { prepend : "<p>", append : "</p>"})

            var buttonText = "More Details"
            print('<a class="btn-link" ' + buildCardHref(assetId) + '>' + buttonText + '</a>')

            print('</div></div>')
          }   // drawColumnCard


        </script>







            </div>

            <!--@@ Buttons paint layout @@-->
            <script runat="server">
              this.args = {
                btn_wrapper: {
                  opening: '<div class="row"><div class="col-sm-12">',
                  closing: '</div></div>'
                }
              }
            </script>
            %asset_contents_paint_394551%
        </div>
    </div>
<script runat="server">print(parts.closing)</script>
